variables:
  nproc: "1"


before_script:
  - nproc=`grep -c '^processor' /proc/cpuinfo`
  - echo "nproc = $nproc"
  - export LD_LIBRARY_PATH=$HOME/boost_1_61_0/stage/lib/:$LD_LIBRARY_PATH
   
   
#========== Pipeline ==================
stages:
  - configure
  - compile
  - unit_test
  - rimea
#=====================================

#============== configure ============
configure-linux:
  artifacts:
    name: "${CI_BUILD_NAME}"
    expire_in: 1 hour
    paths:
      - build
      - ${CI_PROJET_DIR}/lib
  script:
    - mkdir -p build
    - cd build
    - cmake -DBUILD_TESTING=ON -DBoost_NO_SYSTEM_PATHS=true -DBOOST_ROOT=~/boost_1_61_0 ..
    - echo $CI_PROJET_DIR
  stage: configure
  tags:
    - linux
#============== compile ============
make-linux:
  dependencies:
    - configure-linux
  artifacts:
    name: "${CI_BUILD_NAME}"
    expire_in: 1 hour # optional expiry
    paths:
      - build
      - ${CI_PROJET_DIR}/lib
      - ${CI_PROJET_DIR}/bin
      
  stage: compile
  script:
    - cd build
    - make -j$nproc
    - echo $CI_PROJET_DIR
   
#============== unit_test ============
test:
  dependencies:
    - make-linux

  stage: unit_test 
  script:
    - cd build
    - ctest -R Boost
  tags:
    - linux
#============== rimea ============
verify:
  dependencies:
    - make-linux

  stage: rimea
  script:
    - echo "curl -X POST -F token=$TOKEN -F ref=develop https://gitlab.version.fz-juelich.de/api/v3/projects/262/trigger/builds"| at 22:00
    - cd build
    - ctest -R rimea
  only: 
    - develop
  tags:
    - linux
#=================================

after_script:
  - echo "End CI"